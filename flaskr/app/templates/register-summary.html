<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioAuth - Home</title>
    <link href="../static/css/output.css" rel="stylesheet">
</head>


<body class="w-screen h-screen bg-[#EFEFEF] flex justify-center items-center">
    <main class="flex flex-col justify-center items-center w-2/3">
        <a href="/" class="flex flex-row h-fit items-center w-fit space-x-2">
            <img src="../static/images/logoBioAuth.png" alt="BioAuth-logo" class="w-10 object-cover">
            <p class="font-bold text-2xl">BioAuth</p>
        </a>
        <div class=" flex items-center w-full my-2">
            <div class="w-full flex justify-center">
                <p class="text-4xl font-semibold text-[#0A0A0A]">
                    Create an Account
                </p>
            </div>
        </div>
        <!-- Actual User Info -->
        <div class="flex flex-col w-full">
            <p class="font-semibold text-2xl mt-8">Verify Your details</p>
            <img id="facePreview" class="flex self-center w-1/3 h-1/3 rounded-3xl" alt="face image">
            <!-- Grid with user info -->
            <div class="grid grid-cols-4 space-x-2 w-full text-[#0A0A0A] mt-2">
                <div class="flex flex-col">
                    <p class="font-semibold">Username</p>
                    <p class="opacity-75">{{ user_obj['username'] }}</p>
                </div>
                <div class="flex flex-col">
                    <p class="font-semibold">Email</p>
                    <p class="opacity-75">{{ user_obj['email'] }}</p>
                </div>
                <div class="flex flex-col">
                    <p class="font-semibold">Address</p>
                    <p class="opacity-75">{{ user_obj['address'] }}</p>
                </div>
                <div class="flex flex-col">
                    <p class="font-semibold">Phone Number</p>
                    <p class="opacity-75">{{ user_obj['phone'] }}</p>
                </div>
            </div>
            <div id="errorMessage" class="hidden text-red-500 text-sm"></div>
            <div id="loadingState" class="hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="text-sm text-gray-600">Processing registration...</p>
            </div>
            <button onclick="submitRegistration()" id="submitBtn"
                class="bg-[#0A0A0A] transition duration-300 px-12 py-3 rounded-full hover:scale-105 cursor-pointer flex flex-row space-x-2 items-center w-fit">
                <p class="font-semibold text-white">Finalize</p>
                <svg xmlns="http://www.w3.org/2000/svg" width="29" height="29" viewBox="0 0 29 29" fill="none">
                    <path
                        d="M11.5398 21.75L4.65234 14.8625L6.37422 13.1406L11.5398 18.3062L22.6263 7.21979L24.3482 8.94166L11.5398 21.75Z"
                        fill="white" />
                </svg>
            </button>
    </main>

    <script>
        async function submitRegistration() {
            const submitBtn = document.getElementById('submitBtn');
            const loadingElement = document.getElementById('loadingState');
            const errorElement = document.getElementById('errorMessage');

            try {
                // Disable button
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50');
                
                // Show loading state
                loadingElement.classList.remove('hidden');
                errorElement.classList.add('hidden'); // Hide any previous errors

                const response = await fetch('/register/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                // Registration successful
                window.location.href = '/login';

            } catch (error) {
                console.error('Registration error:', error);
                errorElement.textContent = error.message;
                errorElement.classList.remove('hidden');
                
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Get the image_id from your template
                const imageId = '{{ user_obj.face_data_id }}';

                // Fetch the image data
                const response = await fetch(`/get-face-image/${imageId}`);
                const data = await response.json();
                console.log(data)

                if (data.image_data) {
                    // Assuming the image data is a base64 string
                    const facePreview = document.getElementById('facePreview');
                    facePreview.src = data.image_data;
                } else {
                    console.error('No image data found');
                }
            } catch (error) {
                console.error('Error fetching face image:', error);
            }
        });
    </script>
</body>

</html>